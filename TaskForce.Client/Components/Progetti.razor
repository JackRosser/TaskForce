@inherits ProgettiBase
@using TaskForce.Enum;

@foreach (var progetto in List)
{
    var isShow = progetto.Id == ProgettoVisualizzatoId;
    <div class="@($"progettocontainer {(isShow ? "d-flex" : "d-none")} {Theme}")">
        <CountDown @ref="_countDown" SezioneCreata="AfterNuovaSezione" Progetto="@progetto" />
        <div class="macrobox">
        @if (progetto.MacroFasi is not null)
        {
            foreach (var macro in progetto.MacroFasi)
            {
                    <div class="macrocontainer" draggable="true"
                         @ondragstart="() => OnDragStart(macro)"
                         @ondragover:preventDefault="true"
                         @ondragover="OnDragOver"
                         @ondrop="() => OnDrop(progetto, macro)">
                    <h2>
                        <span>
                            <span>
                                @macro.Nome
                            </span>
                            <span>
                                <Icon Element="@Icons.AddFase" Pointer="true" Color="@($"{Theme}-primary")" ToolTip="Aggiungi una fase" OnClick="() => Start(progetto, macro.Id)" />
                            </span>
                        </span>
                        <Icon Element="@Icons.Edit" Pointer="true" CssClass="fs-6" ToolTip="Modifica sezione" OnClick="() => StartEdit(macro)" />
                    </h2>
                    @if (macro.Fasi is not null)
                    {
                        <table class="macro-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    @foreach (var header in Headers)
                                    {
                                        <th>@header.Name</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var fase in macro.Fasi)
                                {
                                        <tr>
                                        <td><Icon Element="@Icons.Edit" Pointer="true" ToolTip="Modifica Task" OnClick="() => StartEditFase(fase)"/></td>
                                        <td class="intestazione">@fase.Nome</td>
                                        <td>@fase.GiorniPrevisti</td>
                                        <td><Badge StatoDiFase="@fase.Stato" /></td>
                                        <td>

                                            <TabDevelopers Fase="@fase" Update="AfterNuovaFase"/>

                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            }
        }
    </div>
        </div>
}

<Headers List="@List" ProgettoAttivo="@ProgettoVisualizzatoId" ProgettoAttivoChanged="SetId" Update="NuovoProgettoVisualizzatoImmediatamente" />



<PopUp IsForm="true"
       Model="@Form"
       Update="AfterNuovaFase"
       OnSubmit="Submit"
       Title="Crea una nuova lavorazione"
       @ref="_popup">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 mb-3">
                <label for="nome" class="form-label">Nome</label>
                <InputText id="nome" class="form-control" @bind-Value="@Form.Nome" />
            </div>
            <div class="col-6">
                <label for="giorniprevisti" class="form-label">Giorni previsti</label>
                <InputNumber id="giorniprevisti" class="form-control" @bind-Value="@Form.GiorniPrevisti" />
            </div>
            <div class="col-6">
                <EnumSelector Label="Tipo di lavorazione" TEnum="Tipologia?" @bind-Value="Form.TipoFase" Id="tipo" ShowDefaultOption="true" />
            </div>
        </div>
    </div>
</PopUp>

<PopUp IsForm="true"
       Model="@UpdateForm"
       Update="AfterNuovaFase"
       OnSubmit="ModificaSezione"
       Title="Modifica questa sezione"
       @ref="_popupEditSection">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <label for="nome" class="form-label">Nome</label>
                <InputText id="nome" class="form-control" @bind-Value="@UpdateForm.Nome" />
            </div>
            <div class="col-12 my-5">
                <Button Color="danger" CssClass="w-100" OnClick="EliminaSezione" Text="Elimina questa sezione"/>
            </div>
        </div>
    </div>
</PopUp>

<PopUp IsForm="true"
       Model="@UpdateFaseForm"
       Update="AfterNuovaFase"
       OnSubmit="ModificaFase"
       Title="Modifica questa lavorazione"
       @ref="_popupEditFase">
    <div class="container-fluid">
        <div class="row">
            <div class="col-6 mb-3">
                <label for="nome" class="form-label">Nome</label>
                <InputText id="nome" class="form-control" @bind-Value="@UpdateFaseForm.Nome" />
            </div>
            <div class="col-6 mb-3">
                <label for="giorni" class="form-label">Giorni previsti</label>
                <InputNumber id="giorni" class="form-control" @bind-Value="@UpdateFaseForm.GiorniPrevisti" />
            </div>
            <div class="col-6">
                <EnumSelector Label="Tipo di lavorazione" TEnum="Tipologia" @bind-Value="UpdateFaseForm.TipoFase" Id="tipo"  />
            </div>
            <div class="col-6">
                <EnumSelector Label="Stato" TEnum="StatoFase" @bind-Value="UpdateFaseForm.Stato" Id="tipo"  />
            </div>
            <div class="col-12 my-5">
                <Button Color="danger" CssClass="w-100" OnClick="EliminaFase" Text="Elimina questa lavorazione" />
            </div>
        </div>
    </div>
</PopUp>